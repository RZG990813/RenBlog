name: hugo打包
on:
  push:
    branches:
      - source
  repository_dispatch:
    types:
      - deploy
  workflow_dispatch:
# 仅允许一个并发部署，跳过在进行中的运行与最新排队的运行之间排队的运行。
# 但是，请不要取消进行中的运行，因为我们希望这些生产部署能够完成。
concurrency:
  group: "pages"
  cancel-in-progress: false
# 默认使用bash
defaults:
  run:
    shell: bash

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.153.4
    steps:
      - name: 检出
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - name: 安装Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb
      - name: 使用Hugo构建
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          hugo --gc --minify
      - name: 保存构建结果
        run: |
          mkdir -p ${{ runner.temp }}/hugo_build
          cp -r public ${{ runner.temp }}/hugo_build/
      - name: 配置Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: 切换到main分支
        run: git checkout main
      - name: 删除旧的public目录
        run: rm -rf public
      - name: 复制新的public目录
        run: cp -r ${{ runner.temp }}/hugo_build/public .
      - name: 提交public目录到main分支
        run: |
          git add public
          git commit -m "Update public directory - $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin main

